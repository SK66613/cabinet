<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Конструктор Mini-App — Мастер</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0c0f15; --panel:#121723; --mut:#aab3c2; --text:#e9eef6; --line:rgba(255,255,255,.08);
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .app{display:grid;grid-template-columns:460px 1fr;gap:14px;min-height:100svh;padding:14px;align-items:start}
    @media (max-width:1180px){ .app{grid-template-columns:1fr; padding:10px} }

    .card{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);padding:12px}
    .bar{display:flex;align-items:center;gap:10px}
    .mut{color:var(--mut)} .mini{font-size:12px}
    .h{margin:0 0 8px;font-weight:900}
    .btn{height:38px;padding:0 12px;border-radius:10px;border:1px solid var(--line);background:#1a2131;color:#fff;font-weight:800;cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .btn-primary{background:linear-gradient(180deg,#77a7ff,#2F6FED);border:0;color:#0b0f18}
    .btn-ghost{background:transparent}
    .badge{display:inline-grid;place-items:center;height:26px;padding:0 10px;border-radius:999px;border:1px solid var(--line);background:#1a2131;font-weight:800}
    .input,.select,textarea{width:100%;height:38px;border-radius:10px;border:1px solid var(--line);background:#0f1420;color:#fff;padding:0 10px}
    textarea{height:auto;min-height:80px;padding:10px}
    .cols{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:520px){ .cols{grid-template-columns:1fr} }
    .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#131b29;font-weight:700}
    .grid{display:grid;gap:10px}
    .mut-hr{height:1px;background:var(--line);margin:10px 0}

    /* Аккордеон */
    .acc{display:grid;gap:10px}
    .acc__item{border:1px solid var(--line);border-radius:var(--radius);overflow:hidden;background:#0f1420}
    .acc__head{display:flex;align-items:center;gap:10px;padding:12px 12px;cursor:pointer;background:#121926}
    .acc__head h3{margin:0;font:800 14px/1.2 Inter}
    .acc__chev{margin-left:auto;opacity:.8}
    .acc__body{display:none;padding:12px}
    .acc__item.open .acc__body{display:block}
    .acc__item.open .acc__chev{transform:rotate(90deg)}

    /* Превью */
    .preview{display:grid;gap:8px; align-content:start}
    .toolbar{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .right-head{display:grid;gap:8px}
    iframe{width:360px;max-width:100%;height:78vh;min-height:640px;border:1px solid var(--line);border-radius:16px;background:#000}
    .w100 iframe{width:100%}
    .notice{padding:10px;border:1px dashed var(--line);border-radius:10px;background:#0e1422;color:#cbd6e7}

    .tabs{display:flex;gap:6px;flex-wrap:wrap}
    .tab{height:30px;padding:0 10px;border-radius:999px;border:1px solid var(--line);background:#131b29;color:#fff;font-weight:800;cursor:pointer}
    .tab[aria-pressed="true"]{background:#fff;color:#000;border-color:#fff}

    /* Template list layout */
    .tpl-card{padding:8px}
    .tpl-row{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center}
    .tpl-controls{display:flex;gap:6px;align-items:center}
    .tpl-name{font-weight:800;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  </style>
</head>
<body>
<div class="app">
  <!-- LEFT: Controls -->
  <section class="card">
    <header class="bar" style="justify-content:space-between;margin-bottom:6px;gap:16px">
      <div class="bar" style="gap:8px">
        <div class="badge">Конструктор Mini-App</div>
        <span class="mut mini" id="api_hint"></span>
      </div>
      <div class="cols" style="grid-template-columns:1fr;gap:6px;min-width:260px">
        <input id="api_base_input" class="input" placeholder="API_BASE, например: https://constructor-miniapp.cyberian13.workers.dev">
      </div>
    </header>

    <div class="grid">
      <div class="cols">
        <label class="grid">
          <span class="mut mini">App ID</span>
          <input id="app_id" class="input" placeholder="например: beer_demo_1">
        </label>
        <label class="grid">
          <span class="mut mini">Вертикаль</span>
          <select id="vertical" class="select">
            <option value="beer">Пиво</option>
            <option value="coffee">Кофе</option>
            <option value="flowers">Цветы</option>
          </select>
        </label>
      </div>

      <!-- ACCORDION -->
      <div class="acc" id="acc">

        <!-- Шаг 0. Готовый шаблон -->
        <div class="acc__item open" data-acc="tpl">
          <div class="acc__head"><h3>Шаг 0. Готовый шаблон</h3><span class="acc__chev">›</span></div>
          <div class="acc__body grid">
            <div class="cols">
              <label class="grid">
                <span class="mut mini">Выбрать шаблон</span>
                <select id="tpl_builtin" class="select">
                  <option value="">— пусто —</option>
                  <option value="demo-main">Demo Main</option>
                  <option value="salesgenius-main">SalesGenius Main</option>
                </select>
              </label>
              <button class="btn" id="tpl_apply">Применить</button>
            </div>
            <div class="notice mini">
              Блоки создаются «как в макете»: <b>html__…</b> в том же порядке, 1:1 с вёрсткой.
            </div>
            <pre class="mut mini" id="tpl_summary" style="white-space:pre-wrap"></pre>
          </div>
        </div>

        <!-- Шаг 0.1. Секции шаблона -->
        <div class="acc__item open" data-acc="tpl-sections">
          <div class="acc__head"><h3>Шаг 0.1. Секции шаблона</h3><span class="acc__chev">›</span></div>
          <div class="acc__body grid">
            <div id="tpl_list" class="grid"></div>
            <div class="mut mini">Меняй порядок стрелками, скрывай ненужные секции, редактируй HTML — автосейв включён.</div>
          </div>
        </div>

        <!-- Шаг 1. Бренд и обложка -->
        <div class="acc__item" data-acc="brand">
          <div class="acc__head"><h3>Шаг 1. Бренд и обложка</h3><span class="acc__chev">›</span></div>
          <div class="acc__body grid">
            <div class="cols">
              <label class="grid"><span class="mut mini">Название</span><input id="brand_name" class="input" placeholder="Beer Club"></label>
              <label class="grid"><span class="mut mini">Цвет бренда</span><input id="brand_color" class="input" value="#2F6FED"></label>
            </div>
            <div class="cols">
              <label class="grid"><span class="mut mini">Короткое описание</span><input id="brand_sub" class="input" placeholder="Свежие сорта, бонусы и призы"></label>
              <label class="grid">
                <span class="mut mini">Скин темы</span>
                <select id="brand_skin" class="select">
                  <option value="dark-glass">Dark Glass</option>
                  <option value="paper">Paper</option>
                  <option value="dark-solid">Dark Solid</option>
                </select>
              </label>
            </div>
            <div class="mut-hr"></div>
            <div class="cols">
              <label class="grid"><span class="mut mini">Hero заголовок</span><input id="hero_title" class="input" placeholder="Заходи на дегустацию"></label>
              <label class="grid"><span class="mut mini">Hero обложка (URL)</span><input id="hero_cover" class="input" placeholder="https://.../cover.jpg"></label>
            </div>
            <div class="cols">
              <label class="grid"><span class="mut mini">Выравнивание текста</span>
                <select id="hero_align" class="select">
                  <option value="left">Слева</option>
                  <option value="center">По центру</option>
                  <option value="right">Справа</option>
                </select>
              </label>
              <label class="grid"><span class="mut mini">Режим обложки</span>
                <select id="hero_fit" class="select">
                  <option value="cover">cover</option>
                  <option value="contain">contain</option>
                </select>
              </label>
            </div>
            <label class="grid"><span class="mut mini">Доп. CSS темы (опционально)</span>
              <textarea id="theme_css" placeholder=":root { --brand-color:#2F6FED } body{ font-family:Inter }"></textarea>
            </label>
          </div>
        </div>

        <!-- Шаг 2. Меню -->
        <div class="acc__item" data-acc="menu">
          <div class="acc__head"><h3>Шаг 2. Меню (быстрый старт)</h3><span class="acc__chev">›</span></div>
          <div class="acc__body grid">
            <div class="cols">
              <label class="grid"><span class="mut mini">Категория</span><input id="menu_cat" class="input" placeholder="beer/coffee/bouquets"></label>
              <label class="grid"><span class="mut mini">Позиция</span><input id="menu_title" class="input" placeholder="IPA #1"></label>
            </div>
            <div class="cols">
              <label class="grid"><span class="mut mini">Описание</span><input id="menu_sub" class="input" placeholder="хмелевая"></label>
              <label class="grid"><span class="mut mini">Цена, ₽</span><input id="menu_price" class="input" placeholder="390" inputmode="numeric"></label>
            </div>
            <div class="bar"><button class="btn" id="add_pos">Добавить позицию</button><span class="mut mini" id="pos_count">0 позиций</span></div>
          </div>
        </div>

        <!-- Шаг 3. Лояльность -->
        <div class="acc__item" data-acc="loyalty">
          <div class="acc__head"><h3>Шаг 3. Лояльность</h3><span class="acc__chev">›</span></div>
          <div class="acc__body cols">
            <label class="grid"><span class="mut mini">Слотов</span><input id="loyalty_slots" class="input" value="6" inputmode="numeric"></label>
            <label class="grid"><span class="mut mini">PIN (демо)</span><input id="demo_pin" class="input" value="1111"></label>
          </div>
        </div>

        <!-- Шаг 4. Блоки -->
        <div class="acc__item" data-acc="blocks">
          <div class="acc__head"><h3>Шаг 4. Блоки</h3><span class="acc__chev">›</span></div>
          <div class="acc__body grid">
            <div class="tabs" id="block_tabs">
              <button class="tab" data-block="hero" aria-pressed="true">Hero</button>
              <button class="tab" data-block="promo" aria-pressed="true">Promo</button>
              <button class="tab" data-block="menuGrid" aria-pressed="true">MenuGrid</button>
              <button class="tab" data-block="loyaltyCard" aria-pressed="true">Loyalty</button>
              <button class="tab" data-block="stampShelf" aria-pressed="true">Passport</button>
              <button class="tab" data-block="bonusWheel" aria-pressed="true">Колесо</button>
              <button class="tab" data-block="profile" aria-pressed="true">Профиль</button>
            </div>
            <div class="mut mini">Игровые блоки появляются автоматически, если выбрана игра.</div>
          </div>
        </div>

        <!-- Шаг 5. Игры -->
        <div class="acc__item" data-acc="game">
          <div class="acc__head"><h3>Шаг 5. Игры</h3><span class="acc__chev">›</span></div>
          <div class="acc__body grid">
            <div class="cols">
              <label class="grid"><span class="mut mini">Игра</span>
                <select id="game_code" class="select">
                  <option value="">— без игры —</option>
                  <option value="flappy">Bumblebee (embedded)</option>
                </select>
              </label>
              <label class="grid"><span class="mut mini">Попыток/день</span><input id="game_attempts" class="input" value="20" inputmode="numeric"></label>
            </div>
            <div class="mut mini">При выборе игры в «Главной» автоматически появятся блоки <b>Игры</b> и <b>Турнир</b>.</div>
          </div>
        </div>

        <!-- Шаг 6. Черновик / Публикация -->
        <div class="acc__item" data-acc="publish">
          <div class="acc__head"><h3>Шаг 6. Черновик / Публикация</h3><span class="acc__chev">›</span></div>
          <div class="acc__body grid">
            <div class="bar" style="flex-wrap:wrap;gap:8px">
              <button class="btn" id="save_draft">Создать черновик</button>
              <button class="btn" id="preview_btn">Превью черновика</button>
              <button class="btn btn-primary" id="publish_btn">Опубликовать</button>
            </div>
            <div class="notice mini">Блюпринт сохраняется в GAS через ваш Worker. Превью справа рендерит блюпринт «как есть».</div>
          </div>
        </div>

      </div>
    </div>
  </section>

  <!-- RIGHT: Preview -->
  <section class="right-head">
    <div class="card preview">
      <div class="toolbar">
        <div class="bar" style="gap:8px;flex-wrap:wrap">
          <label class="chip"><span class="mut mini">Устройство</span>
            <select id="pv_device" class="select" style="width:auto">
              <option value="360">Телефон (360px)</option>
              <option value="414">Телефон+ (414px)</option>
              <option value="768">Планшет (768px)</option>
              <option value="100%">Ширина панели</option>
            </select>
          </label>
          <label class="chip"><input type="checkbox" id="pv_tgchrome" checked> <span class="mut mini">TG-шапка</span></label>
          <label class="chip"><input type="checkbox" id="pv_demo" checked> <span class="mut mini">Демо-данные</span></label>
          <label class="chip"><span class="mut mini">Вкладка</span>
            <select id="pv_tab" class="select" style="width:auto">
              <option value="/">Главная</option>
              <option value="/tournament">Турнир</option>
              <option value="/play">Играть</option>
              <option value="/bonuses">Бонусы</option>
              <option value="/profile">Профиль</option>
            </select>
          </label>
          <button class="btn" id="open_separate">Открыть отдельно</button>
        </div>
      </div>
      <div class="mut mini" id="prev_url" style="word-break:break-all"></div>
      <div id="frame_wrap"><iframe id="frame" title="Превью мини-аппы"></iframe></div>
    </div>
  </section>
</div>

<script> window.API_BASE = window.API_BASE || localStorage.getItem('ADMIN_API_BASE') || "https://constructor-miniapp.cyberian13.workers.dev"; </script>
<script src="./templates.js"></script>
<script src="./admin.js"></script>
</body>
</html>
